<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Prostration Counter</title>

<style>
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont;
    background: #0f172a;
    color: #e5e7eb;
    text-align: center;
    margin: 0;
    padding: 20px;
  }

  h1 {
    font-size: 1.5rem;
    margin-bottom: 10px;
  }

  .counter {
    font-size: 5rem;
    font-weight: bold;
    margin: 20px 0;
  }

  .timer {
    font-size: 1.2rem;
    margin-bottom: 10px;
  }

  .debug {
    font-size: 0.75rem;
    opacity: 0.7;
    margin-bottom: 20px;
  }

  button {
    font-size: 1rem;
    padding: 12px 20px;
    margin: 8px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
  }

  .start { background: #22c55e; color: #022c22; }
  .stop  { background: #ef4444; color: #450a0a; }
  .reset { background: #38bdf8; color: #082f49; }

  .instructions {
    font-size: 0.9rem;
    opacity: 0.85;
    margin-top: 25px;
    line-height: 1.4;
  }
</style>
</head>

<body>

<h1>ðŸ“¿ Prostration Counter</h1>

<div class="counter" id="count">0</div>
<div class="timer" id="time">00:00</div>
<div class="debug" id="debug">Waitingâ€¦</div>

<button class="start" onclick="start()">Start</button>
<button class="stop" onclick="stop()">Stop</button>
<button class="reset" onclick="resetAll()">Reset</button>

<div class="instructions">
  Place phone in chest pocket or flat on prayer mat.<br>
  Keep orientation consistent.
</div>

<script>
/* =======================
   Configuration
======================= */
const BEND_THRESHOLD = -10;
const PROSTRATION_THRESHOLD = -35;
const STABLE_TIME_MS = 400;
const STABILITY_ACCEL = 0.15;

/* =======================
   State
======================= */
let state = "IDLE";
let uprightPitch = 0;
let prostrationStart = null;
let count = 0;
let startTime = null;
let timerInterval = null;
let running = false;

/* =======================
   Utils
======================= */
function formatTime(ms) {
  const total = Math.floor(ms / 1000);
  const m = String(Math.floor(total / 60)).padStart(2, "0");
  const s = String(total % 60).padStart(2, "0");
  return `${m}:${s}`;
}

/* =======================
   Orientation
======================= */
function handleOrientation(e) {
  if (!running || e.beta == null) return;

  const pitch = e.beta - uprightPitch;

  document.getElementById("debug").textContent =
    `State: ${state} | Pitch: ${pitch.toFixed(1)}`;

  if (state === "UPRIGHT" && pitch < BEND_THRESHOLD) {
    state = "BENDING";
  }

  if (state === "BENDING" && pitch < PROSTRATION_THRESHOLD) {
    state = "PROSTRATION";
    prostrationStart = null;
  }

  if (state === "RETURNING" && Math.abs(pitch) < 10) {
    count++;
    document.getElementById("count").textContent = count;
    state = "UPRIGHT";
  }
}

/* =======================
   Motion (stability)
======================= */
function handleMotion(e) {
  if (!running || state !== "PROSTRATION") return;

  const a = e.accelerationIncludingGravity;
  if (!a) return;

  const mag = Math.abs(a.x) + Math.abs(a.y) + Math.abs(a.z);

  if (mag < STABILITY_ACCEL) {
    if (!prostrationStart) {
      prostrationStart = Date.now();
    } else if (Date.now() - prostrationStart > STABLE_TIME_MS) {
      state = "RETURNING";
    }
  } else {
    prostrationStart = null;
  }
}

/* =======================
   Controls (FIXED)
======================= */
async function start() {
  if (running) return;

  // ðŸ”´ REQUIRED on modern iOS
  if (typeof DeviceMotionEvent?.requestPermission === "function") {
    try {
      const motionPerm = await DeviceMotionEvent.requestPermission();
      const orientPerm = await DeviceOrientationEvent.requestPermission();

      if (motionPerm !== "granted" || orientPerm !== "granted") {
        alert("Motion permission is required.");
        return;
      }
    } catch (err) {
      alert("Motion permission failed.");
      return;
    }
  }

  running = true;
  count = 0;
  state = "CALIBRATING";
  document.getElementById("count").textContent = "0";

  startTime = Date.now();
  timerInterval = setInterval(() => {
    document.getElementById("time").textContent =
      formatTime(Date.now() - startTime);
  }, 1000);

  window.addEventListener("deviceorientation", e => {
    if (state === "CALIBRATING" && e.beta != null) {
      uprightPitch = e.beta;
      state = "UPRIGHT";
    }
    handleOrientation(e);
  });

  window.addEventListener("devicemotion", handleMotion);
}

function stop() {
  running = false;
  clearInterval(timerInterval);
}

function resetAll() {
  stop();
  count = 0;
  state = "IDLE";
  document.getElementById("count").textContent = "0";
  document.getElementById("time").textContent = "00:00";
  document.getElementById("debug").textContent = "Waitingâ€¦";
}
</script>

</body>
</html>
